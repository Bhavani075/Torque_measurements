--Calculate/determine the 10% & 90% measurement points T10 & T90
--integrated with initial torque point

WITH initial_value AS (
    SELECT torque, time, ROW_NUMBER() OVER (ORDER BY time) AS rn
    FROM Measurement_Raw_data
),
-- Find the max(torque),time and its row number
max_torque_data AS (
    SELECT MAX(torque) AS max_torque,time AS max_torque_time, rn AS row_num  
    FROM initial_value
),
--initial torque point, where torque is closest to 0
initial_torque_point AS (
    SELECT torque, time, rn
    FROM initial_value
    WHERE rn < (SELECT row_num FROM max_torque_data) -- Rows before max torque
    AND torque <= 0 -- Torque near 0 
    ORDER BY rn DESC 
    LIMIT 1
),
--Calculate 90% and 10% of the maximum torque
target_torque AS (
    SELECT 0.9 * max_torque AS target_value_90,   -- Calculate 90% of max torque
           0.1 * max_torque AS target_value_10    -- Calculate 10% of max torque
    FROM max_torque_data
),
--to find the torque value closest to 10%(max_torque)
closest_torque_10 AS (
    SELECT torque, time, rn
    FROM initial_value
    WHERE rn < (SELECT row_num FROM max_torque_data) -- Rows before max torque
    AND torque <= (SELECT target_value_10 FROM target_torque)
    ORDER BY torque DESC -- Closest torque for 10% of max torque
    LIMIT 1
),
----to find the torque value closest to 90%(max_torque)
closest_torque_90 AS (
    SELECT torque, time, rn
    FROM initial_value
    WHERE rn < (SELECT row_num FROM max_torque_data) -- Rows before max torque
    AND torque <= (SELECT target_value_90 FROM target_torque)
    ORDER BY torque DESC -- Closest torque for 90% of max torque
    LIMIT 1
)
SELECT 
	(SELECT torque FROM initial_torque_point) AS trq0,
	(SELECT time FROM initial_torque_point) AS t0,
    (SELECT torque FROM closest_torque_10) AS trq10,
    (SELECT time FROM closest_torque_10) AS t10,
    (SELECT torque FROM closest_torque_90) AS trq90,
    (SELECT time FROM closest_torque_90) AS t90,
    max_torque AS trq100,
	max_torque_time AS t100
FROM max_torque_data;
